# 3장 카프카 디자인

## 3.1 카프카 디자인의 특징
### 3.1.1 분산 시스템
- 단일 시스템보다 높은 성능
- 단일 장애 극복(다른 서버가 대체)
- 확장 용이
  - 링크드인의 경우, 트래픽이 많으면 60대의 브로커를 사용
### 3.1.2 페이지 캐시
- 카프카는 OS의 페이지 캐시를 이용하도록 디자인 되었다.
  - 따라서, 값이싼 SATA 디스크를 사용해도 무방하다.
````
카프카는 기본으로 1GB 힙 메모리 사용
````
### 3.1.3 배치 전송 처리
- 카프카는 작은 I/O를 묶어서 처리한다.
  - 단건별로 I/O발생시, 오버헤드가 발생하므로 일정 데이터가 쌓이면 한꺼번에 처리한다.
## 3.2 카프카 데이터 모델
- **토픽**과 **파티션**이라는 데이터 모델이 있다.
  - 토픽 : 메시지를 받을 수 있는 논리적 묶음
  - 파티션 : 토픽을 구성하는 데이터 저장소로 수평 확장 가능한 단위
````
+-------------------+
|      Topic        |
+-------------------+
|   +----------+    |
|   | Partition|    |
|   +----------+    |
|         |         |
|         |         |
|   +----------+    |
|   | Partition|    |
|   +----------+    |
+-------------------+

````
### 3.2.1 토픽의 이해
- 카프카 클러스터는 토픽에 데이터를 저장
- 249자 미만 영문,숫자 `.` , `_` , `-` 를 조합하여 사용
- 토픽이름 규칙 예시
  - sbs-news, sbs-video  
### 3.2.2 파티션의 이해
- 하나의 토픽을 파티셔닝 하는 이유
  - **병렬 처리**
  - 확장성
- 무조건 파티션 수를 늘려야하나? -> 아니다
  - 파일 핸들러의 낭비
    - 각 파티션은 브로커의 디렉토리와 매핑, 저장되는 데이터마다 인덱스 및 실제 데이터를 저장한다.
  - 장애 복구 시간 증가
    - 파티션 별로 새로운 리더를 선출하는데 오래걸릴 수 있기 때문이다.
- 내 토픽의 적절한 파티션 수는?
  - **처리량 기준**을 잡아야 한다.
  - **컨슈머 입장도 고려**해야한다.
### 3.2.3 오프셋과 메시지 순서
- 각 파티션마다 메세지가 저장되는 위치를 **오프셋** 이라고 부른다.
  - **파티션 마다 유일한 숫자**를 갖는다.
  - **절대로 오프셋 순서가 바뀐 상태로는 가져갈 수 없다.**
````
파티션 0 0123456
파티션 1 0123456789
파티션 2 0123
````
## 3.3 카프카의 고가용성과 리플리케이션
- 물리적 장애 발생시, 높은 가용성을 보장
  - 복제 기능 제공
  - 토픽을 리플리케이션하는것이 아니라, **토픽의 각각 파티션을 리플리케이션**하는 것이다.
### 3.3.1 리플리케이션 팩터와 리더, 팔로워의 역할
- 카프카에는 리플리케이션 **팩터**라는 것이 있다.
  - 기본 팩터는 1이다.
- **모든 읽기와 쓰기는 리더를 통해서만 일어난다**.
  - 팔로워는 리플리케이션만 진행한다.
  - 리더와 팔로워는 저장된 데이터 순서도 일치, 동일한 오프셋과 메시지들을 갖는다.
- 만약 topic의 파티션 전체가 100GB 라면, 팔로워도 100GB 디스크 용량을 사용하는 단점이 있다.
- **데이터 중요도에 따라 리플리케이션 팩터를 2 또는 3으로 설정해 사용하는 것이 효율적**이다.
````
+-------------------------------+        +-------------------------------+
|            Kafka Topic        |        |            Kafka Topic        |
+-------------------------------+        +-------------------------------+
|                               |        |                               |
|        +---------+            |        |        +---------+            |
|        |  Leader |            |        |        | Follower|            |
|        +---------+            |        |        +---------+            |
|             |                 |        |             |                 |
|             |                 |        |             |                 |
|             | Replication     |        |             |                 |
|             | Heartbeats      |        |             | Sync Data       |
|             v                 |        |             v                 |
|        +---------+            |        |        +---------+            |
|        |  Follower|           |        |        |   Leader  |          |
|        +---------+            |        |        +---------+            |
|                               |        |                               |
+-------------------------------+        +-------------------------------+

````
- 리더 장애시, 팔로워중 하나가 리더가 된다.
````
+-------------------------------+        +-------------------------------+
|            Kafka Topic        |        |            Kafka Topic        |
+-------------------------------+        +-------------------------------+
|                               |        |                               |
|        +---------+            |        |        +---------+            |
|        |  Leader |            |        |        |  Leader |            |
|        +---------+            |        |        +---------+            |
|             |                 |        |             |                 |
|             |                 |        |             |                 |
|             |    Failure      |        |             |                 |
|             v                 |        |             v                 |
|        +---------+            |        |        +---------+            |
|        |  Follower|           |        |        |  Candidate Leader    |
|        +---------+            |        |        +---------+            |
|                               |        |                               |
+-------------------------------+        +-------------------------------+

````

### 3.3.2 리더와 팔로워의 관리
- ISR이라는 그룹을 만들어 리더 & 팔로워를 관리한다.
  - ISR(In-Sync Replica) 그룹은 리더와 동기화된 팔로워(replica)들의 집합
  - **ISR 그룹에 속한 팔로워들은 리더의 역할을 대신할 수 있는 후보**가 된다.
    - 리플리케이션 팩터가 3이면, 2개의 팔로워가 존재
    - 리더는 만약 설정 주기만큼 데이터 싱크 확인요청이 오지 않는다면, ISR 에서 제외시킨다.(replica.lag.itme.max.ms)
````
+-------------------+    Leader      +-------------------+     ISR         +-------------------+
|    Kafka Topic    | -------------> |    Kafka Topic    | ------------->  |    Kafka Topic    |
|    Replication:3  |                |    Replication:3 |                  |    Replication:3  |
+-------------------+                +-------------------+                 +-------------------+
|                   |                |                   |                 |                   |
|      +---------+  |                |      +---------+  |                 |      +---------+  |
|      |  Leader |  |                |      |  Leader |  |                 |      |  Leader |  |
|      +---------+  |                |      +---------+  |                 |      +---------+  |
|           |       |                |           |       |                 |           |       |
|           |       |                |           |       |                 |           |       |
|           |       |                |           v       |                 |           v       |
|           v       |                |      +---------+  |                 |      +---------+  |
|      +---------+  |                |      | Follower|  |                 |      | Follower|  |
|      | Follower|  |                |      +---------+  |                 |      +---------+  |
|      +---------+  |                |                   |                 |                   |
|                   |                +-------------------+                 +-------------------+
+-------------------+

````
## 3.4 모든 브로커가 다운된다면
- 모든 브로커가 종료되었다고 가정
- 2가지 선택지가 있다.
  - 첫째, 마지막 리더가 살아나기를 기다린다.
    - unclean.leader.election.enable.true
  - 둘째, ISR에서 추방되었지만 먼저 살아나면 자동으로 리더가 된다.
    - unclean.leader.election.enable.false
- 메세지 손실을 하지 않게하려면, **마지막 리더를 먼저 복구하도록 해야한다**.

## 3.5 카프카에서 사용하는 주키퍼 지노드 역할
