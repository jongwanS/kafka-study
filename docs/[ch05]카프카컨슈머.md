# 5장 카프카 컨슈머
- 컨슈머(cunsumer)
  - 프로듀서가 메시지를 생산하여 카프카 토픽으로 메세지를 보내고 **그 토픽의 메시지를 가져와서 소비하는 역할**을 하는 **애플리케이션** 또는 **서버**
  - 컨슈머는 특정 파티션을 관리하고 있는 파티션 리더에게 메세지를 가져오도록 요청
    - 각 요청은 **로그의 오프셋을 명시**,그 위치로부터 로그 메시지를 수신
  - 컨슈머는 가져올 메시지의 위치를 조정할 수 있고, 데이터도 다시 가져올 수 있다.

## 5.1 컨슈머 주요 옵션
- 카프케엇 컨슈머는 두가지 종류가 있다.(올드 컨슈머, 뉴 컨슈머)
  - 두 컨슈머의 큰 차이는 **주키퍼의 사용 유무**이다.
  - **구 버전의 카프카는 컨슈머**의 오프셋을 **주키퍼의 지노드**에 저장
  - **뉴 컨슈머**는 카프카 **토픽에 오프셋**을 저장한다.
#### [뉴 컨슈머]
- bootstrap.servers
  - 카프카 클러스터에 연결을 하기 위한 호스트&포트정보
- fetch.min.bytes
  - 한번에 가져올 수 있는 최소 데이터 사이즈
- group.id
  - 컨슈머가 속한 **컨슈머 그룹을 식별하는 식별자**
- enable.auto.commit
  - 백그라운드로 주기적으로 오프셋을 커밋
- augo.offset.reset
  - 초기 오프셋이 없거나, 현재 오프셋이 더 이상 존재하지 않으면(데이터삭제) 리셋한다
    - earliest : 가장 초기의 오프셋값으로 설정
    - latest : 가장 마지막의 오프셋값으로 설정
    - none : 이전 오프셋값을 찾지 못하면 에러를 나타낸다.
- fetch.max.bytes
  - 한번에 가져올 수 있는 최대 데이터 사이즈
- request.timeout.ms
  - 요청에 대해 응답을 기다리는 최대 기간
- session.timeout.ms
  - 컨슈머와 브로커사이의 세션 타임 아웃 시간
  - 컨슈머가 그룹 코디네이터에게 하트비트를 보내지 않고 session.timeout.ms이 지나면 해당 컨슈머는 종료되거나 장애가 발생한 것으로 판단하여 컨슈머 그룹은 **리밸런스**를 시도한다.
  - session.timeout.ms 를 기본값(10초)보다 낮게 설정하면 실패 빨리감지 하지만, **원하지 않은 리밸런스**가 일어날 수 있다.
- heartbeat.interval.ms
  - 그룹 코디네이터에게 얼마나 자주 KafkaConsumer poll() 메서드로 하트비트를 보낼 것인지 조정
  - session.timeout.ms 와 밀접관련이 있고, session.timeout.ms 보다 낮아야 한다.(기본값은 3초 , **일반적으로 3/1정도로 설정**한다.)
- max.poll.records
  - 단일 호출 poll()에 대한 최대 레코드 수를 조정한다.
  - 이 옵션을 통해 애플리케이션이 폴링 루프에서 데이터 양을 조정할 수 있다.
- max.poll.interval.ms
  - 컨슈머가 살아있는지를 체크하기 위해 하트비트를 주기적으로 보내는데, 컨슈머가 계속해서 하트비트만 보내고 실제로 메시지를 가져가지 않는 경우가 있을 경우 
    장애라고 판단하고 컨슈머 그룹에서 제외, 다른 컨슈머가 해당 파티션에서 메시지를 가져갈 수 있게 한다. 
- auto.commit.interval.ms
  - 주기적으로 오프셋을 커밋하는 시간
- fetch.max.wait.ms
  - fetch.min.bytes에 의해 설정된 데이터보다 적은 경우 요청에 응답을 기다리는 최대 시간

## 5.2 콘솔 컨슈머로 메시지 가져오기
- **컨슈머는 토픽에서 메시지를 가져오는 역할을 한다.**

## 5.3 자바와 파이썬을 이용한 컨슈머
## 5.4 파티션과 메세지 순서
### 5.4.1 파티션과 메세지 순서
- 카프카 컨슈머에서의 메시지 순서는 **동일한 파티션 내에서는 생성한 순서와 동일하게 처리**
- **하지만, 파티션과 파티션 사이에서는 순서를 보장하지 않는다.**
- **만약에 순서를 보장해야하는경우**에는 **파티션 1개로 구성**한다.
### 5.4.2 파티션 1개로 구성한 peter-02토픽과 메시지순서
- 토픽을 만들때, 파티션을 1개로 만든다.
  - 파티션 수를 1개로 할경우, 순서는 보장되지만 **분산처리가 불가**하며 **처리량이 높지 않다**.
````shell
kafka-topics.sh --create --topic sequence-topic --bootstrap-server localhost:9092 --replication-factor 1 --partitions 
````
## 5.5 컨슈머 그룹
- 컨슈머 그룹은 **하나의 토픽**에 **여러 컨슈머 그룹이 동시에 접속**해 메시지를 가져올 수 있다.
## 5.6 커밋과 오프셋
### 5.6.1 자동 커밋
### 5.6.2 수동 커밋
### 5.6.3 특정 파티션 할당
### 5.6.4 특정 오프셋부터 메시지 가져오기
### 5.6.5 정리